from flask import Flask, jsonify, request
from flask_cors import CORS
from flask_limiter import Limiter
from sqlalchemy import create_engine, text

# ---------- Database ----------
engine = create_engine(
    "mysql+pymysql://4J4VubRMtDYVKrk.root:OFOP2eUkZFWs0rvM@gateway01.ap-southeast-1.prod.aws.tidbcloud.com:4000/perfume_product_db",
    connect_args={"ssl": {"ca": "/etc/ssl/cert.pem"}},
    pool_size=10,
    max_overflow=20,
    pool_recycle=1800,
    pool_pre_ping=True,
)

# ---------- Upstash Redis (HARD-CODED) ----------
REDIS_URI = (
    "rediss://:"
    "AUnRAAIncDI3YTk1YTk5NjBmYzU0YWY0OWMzZTRiMDBjNGJiZmYwYXAyMTg4OTc"
    "@enormous-mule-18897.upstash.io:6379"
)

# ---------- Helpers ----------
def get_ip():
    if "X-Forwarded-For" in request.headers:
        return request.headers["X-Forwarded-For"].split(",")[0].strip()
    return request.remote_addr

def get_data():
    with engine.connect() as conn:
        result = conn.execute(
            text("SELECT name, quantity, price, img_link, description FROM products_tbl")
        )
        return [dict(row._mapping) for row in result]

# ---------- App ----------
app = Flask(__name__)
CORS(app)

limiter = Limiter(
    app=app,
    key_func=get_ip,
    storage_uri=REDIS_URI
)

# ---------- Routes ----------
@app.route("/", methods=["GET"])
@limiter.limit("30 per minute")
def index():
    return jsonify({"products": get_data()})

# ---------- Entrypoint ----------
if __name__ == "__main__":
    app.run(host="0.0.0.0", debug=False)
